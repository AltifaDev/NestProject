---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import PropertyForm from "../../../components/dashboard/PropertyForm.tsx";
import { payloadClient } from "../../../lib/payload-client";

const { id } = Astro.params;
const property = await payloadClient.getProperty(id as string);
---

<BaseLayout title={`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ${property ? property.title : 'Property'} | Edit Listing`}>
    <div class="dashboard-root">
        <!-- Sidebar Navigation -->
        <aside class="dashboard-sidebar">
            <div class="sidebar-header">
                <div class="brand-box">
                    <div class="brand-logo shadow-2xl shadow-accent-primary/20">N</div>
                    <div class="brand-info">
                        <span class="brand-name">NEST ELITE</span>
                        <span class="brand-tag">AGENT PORTAL</span>
                    </div>
                </div>
            </div>

            <nav class="sidebar-menu">
                <div class="menu-section">
                    <span class="section-title">CORE / ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</span>
                    <a href="/dashboard" class="menu-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="item-icon"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                        <span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö (Overview)</span>
                    </a>
                    <a href="/dashboard" class="menu-item active">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="item-icon"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                        <span>‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Properties)</span>
                    </a>
                </div>

                <div class="menu-section">
                    <span class="section-title">ENGAGEMENT / ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</span>
                    <a href="#" class="menu-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="item-icon"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        <span>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Leads)</span>
                    </a>
                    <a href="#" class="menu-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="item-icon"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        <span>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô (Calendar)</span>
                    </a>
                </div>

                <div class="menu-section">
                    <span class="section-title">GROWTH / ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</span>
                    <a href="#" class="menu-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="item-icon"><path d="m3 11 18-5v12L3 14v-3z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/></svg>
                        <span>‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î (Marketing)</span>
                    </a>
                    <a href="#" class="menu-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="item-icon"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>
                        <span>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏• (Performance)</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button id="theme-toggle" class="theme-switch" aria-label="Toggle Theme">
                    <div class="switch-icons">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sun-icon"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="moon-icon"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                    </div>
                    <span class="switch-text">‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î (Theme)</span>
                </button>
                <div class="footer-divider"></div>
                <button id="logout-btn" class="menu-item logout">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="item-icon text-accent-danger"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <div class="greeting-box">
                    <h1 class="welcome-text">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏™‡∏±‡∏á‡∏´‡∏≤‡∏Ø</h1>
                    <p id="user-display" class="user-id">Reviewing property details ‚ú®</p>
                </div>
                <div class="header-actions">
                    <div class="profile-summary">
                        <div class="profile-text text-right">
                            <span id="user-email-full" class="email-label">agent@nest.com</span>
                            <span class="badge-elite">Elite Member</span>
                        </div>
                        <div class="profile-orb"></div>
                    </div>
                </div>
            </header>

            <div class="main-scroll">
                <div class="max-w-7xl mx-auto">
                    <PropertyForm client:only="react" initialData={property} />
                </div>
            </div>
        </main>
    </div>
</BaseLayout>

<script>
    import { payloadClient } from "../../../lib/payload-client";

    // Theme Switch Logic
    const themeBtn = document.getElementById('theme-toggle');
    themeBtn?.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    });

    // Auth Check
    const user = payloadClient.getUser();
    if (!user) {
        window.location.href = "/agent/login";
    } else {
        const display = document.getElementById('user-display');
        const displayFull = document.getElementById('user-email-full');
        const hour = new Date().getHours();
        const greet = hour < 12 ? '‡∏≠‡∏£‡∏∏‡∏ì‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå' : hour < 18 ? '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡∏ö‡πà‡∏≤‡∏¢' : '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô';
        
        if (display) display.textContent = `${greet}, ${user.email.split('@')[0]} üëã`;
        if (displayFull) displayFull.textContent = user.email;
    }

    // Logout
    document.getElementById('logout-btn')?.addEventListener('click', () => {
        if(confirm('‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            payloadClient.logout();
            window.location.href = "/agent/login";
        }
    });
</script>
