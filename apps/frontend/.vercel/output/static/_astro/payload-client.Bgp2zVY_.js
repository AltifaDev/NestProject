const p="http://localhost:3000";class u{baseURL;token=null;constructor(e=p){this.baseURL=e,typeof window<"u"&&(this.token=localStorage.getItem("payload_token"))}async request(e,t={}){const r=`${this.baseURL}${e}`,n={"Content-Type":"application/json",...t.headers||{}};this.token&&(n.Authorization=`JWT ${this.token}`);try{const o=await fetch(r,{...t,headers:n});o.status===401&&typeof window<"u"&&this.logout();const a=await o.json();if(!o.ok)throw new Error(a.errors?.[0]?.message||`Request failed with status ${o.status}`);return a}catch(o){throw console.error("Payload request error:",o),o}}async login(e,t){const r=await this.request("/api/users/login",{method:"POST",body:JSON.stringify({email:e,password:t})});return r.token&&(this.token=r.token,typeof window<"u"&&(localStorage.setItem("payload_token",r.token),localStorage.setItem("payload_user",JSON.stringify(r.user)))),r}logout(){this.token=null,typeof window<"u"&&(localStorage.removeItem("payload_token"),localStorage.removeItem("payload_user"),window.location.href="/agent/login")}getUser(){if(typeof window<"u"){const e=localStorage.getItem("payload_user");return e?JSON.parse(e):null}return null}async getFreshestUser(){const e=this.getUser();if(!e)return null;try{const t=await this.request("/api/users/me");if(t?.user)return typeof window<"u"&&localStorage.setItem("payload_user",JSON.stringify(t.user)),t.user}catch(t){console.warn("Failed to fetch freshest user data",t)}return e}async getMyProperties(){const e=await this.getFreshestUser();if(!e)return{docs:[]};if(e.role==="admin")return this.request("/api/properties?depth=2&limit=100");if(!e.agent)return{docs:[]};const t=typeof e.agent=="object"?e.agent.id:e.agent;return this.request(`/api/properties?where[agent][equals]=${t}&depth=2&limit=100`)}async createProperty(e){return this.request("/api/properties",{method:"POST",body:JSON.stringify(e)})}async updateProperty(e,t){return this.request(`/api/properties/${e}`,{method:"PATCH",body:JSON.stringify(t)})}async getProperty(e){return this.request(`/api/properties/${e}?depth=2`)}async deleteProperty(e){return this.request(`/api/properties/${e}`,{method:"DELETE"})}async incrementViewCount(e){try{const r=(await this.request(`/api/properties/${e}?depth=0`))?.view_count||0;await this.request(`/api/properties/${e}`,{method:"PATCH",body:JSON.stringify({view_count:r+1})})}catch(t){console.warn("Failed to increment view count:",t)}}async uploadMedia(e,t=3){const r=new FormData;r.append("file",e);const n=e.name.replace(/\.[^/.]+$/,"").replace(/[-_]/g," ");r.append("alt",n);const o=`${this.baseURL}/api/media`;for(let a=1;a<=t;a++)try{const s=await fetch(o,{method:"POST",headers:{Authorization:`JWT ${this.token}`},body:r});if(!s.ok){const l=(await s.json().catch(()=>null))?.errors?.[0]?.message||`Upload failed with status ${s.status}`;throw new Error(l)}return await s.json()}catch(s){if(console.warn(`Upload attempt ${a}/${t} failed:`,s),a===t)throw s;await new Promise(i=>setTimeout(i,500*Math.pow(2,a-1)))}throw new Error("Failed to upload media after all retries")}}const d=new u;export{p as P,d as p};
