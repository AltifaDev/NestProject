---
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import PropertyForm from "../../components/dashboard/PropertyForm.tsx";
import NotificationBell from "../../components/dashboard/NotificationBell.tsx";
---

<DashboardLayout title="Add New Property | Nest Elite">
    <div class="dashboard-root">
        <!-- Sidebar Navigation -->
        <aside class="dashboard-sidebar">
            <div class="sidebar-header">
                <div class="brand-box">
                    <div class="brand-logo">N</div>
                    <div class="brand-info">
                        <span class="brand-name">NEST ELITE</span>
                        <span class="brand-tag">AGENT PORTAL</span>
                    </div>
                </div>
            </div>

            <nav class="sidebar-menu">
                <div class="menu-section">
                    <span class="section-title">CORE</span>
                    <a href="/dashboard" class="menu-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="item-icon"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                        <span>Overview</span>
                    </a>
                    <a href="/dashboard" class="menu-item active">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="item-icon"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                        <span>Properties</span>
                    </a>
                </div>

                <div class="menu-section">
                    <span class="section-title">ENGAGEMENT</span>
                    <a href="/dashboard/leads" class="menu-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="item-icon"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        <span>Leads & CRM</span>
                    </a>
                    <a href="/dashboard/calendar" class="menu-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="item-icon"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                        <span>Calendar</span>
                    </a>
                </div>

                <div class="menu-section">
                    <span class="section-title">GROWTH</span>
                    <a href="/dashboard/marketing" class="menu-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="item-icon"><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></svg>
                        <span>Marketing</span>
                    </a>
                    <a href="/dashboard/performance" class="menu-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="item-icon"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
                        <span>Analytics</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button id="theme-toggle" class="theme-switch" aria-label="Toggle Theme">
                    <div class="switch-icons">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sun-icon"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="moon-icon"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                    </div>
                    <span class="switch-text">Switch Theme</span>
                </button>
                <div class="footer-divider"></div>
                <button id="logout-btn" class="menu-item logout">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="item-icon logout-icon"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="dashboard-main">
            <header class="main-header">
                <div class="greeting-box">
                    <h1 class="welcome-text">Create New Property</h1>
                    <p id="user-display" class="user-id">Drafting your next success ✨</p>
                </div>
                <div class="header-actions">
                    <NotificationBell client:load />
                    <div class="profile-summary">
                        <div class="profile-text">
                            <span id="user-email-full" class="email-label"></span>
                            <span class="badge-elite">Elite Member</span>
                        </div>
                        <div class="profile-orb"></div>
                    </div>
                </div>
            </header>

            <div class="main-scroll">
                <div class="content-wrapper">
                    <PropertyForm client:only="react" />
                </div>
            </div>
        </main>
    </div>
</DashboardLayout>

<script>
    import { payloadClient } from "../../lib/payload-client";

    // Theme Switch Logic
    const themeBtn = document.getElementById('theme-toggle');
    themeBtn?.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    });

    // Auth Check
    const user = payloadClient.getUser();
    if (!user) {
        window.location.href = "/agent/login";
    } else {
        const display = document.getElementById('user-display');
        const displayFull = document.getElementById('user-email-full');
        // Custom greeting for this page
        
        if (displayFull && user.email) displayFull.textContent = user.email;
        if (display && user.email) display.textContent = `Drafting for ${user.email.split('@')[0]} ✨`;
    }

    // Logout
    document.getElementById('logout-btn')?.addEventListener('click', () => {
        if(confirm('Are you sure you want to logout?')) {
            payloadClient.logout();
            window.location.href = "/agent/login";
        }
    });
</script>

<style>
    /* ============================================================
       ROOT LAYOUT
       ============================================================ */
    .dashboard-root {
        display: flex;
        height: 100vh;
        width: 100vw;
        background-color: var(--bg-main);
        overflow: hidden;
    }

    /* ============================================================
       SIDEBAR
       ============================================================ */
    .dashboard-sidebar {
        width: var(--sidebar-width, 260px);
        min-width: var(--sidebar-width, 260px);
        background-color: var(--bg-sidebar);
        border-right: 1px solid var(--border-subtle);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        z-index: 50;
        overflow: hidden;
    }

    .sidebar-header {
        padding: 2rem 1.5rem 1.5rem;
        flex-shrink: 0;
    }

    .brand-box {
        display: flex;
        align-items: center;
        gap: 0.875rem;
    }

    .brand-logo {
        width: 40px;
        height: 40px;
        min-width: 40px;
        background-color: var(--text-main);
        color: var(--bg-sidebar);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 1.1rem;
        box-shadow: 0 6px 14px -4px rgba(0,0,0,0.3);
    }

    .brand-info {
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    .brand-name {
        font-weight: 700;
        letter-spacing: 0.05em;
        font-size: 0.85rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text-main);
    }

    .brand-tag {
        font-size: 0.58rem;
        color: var(--text-dim);
        font-weight: 700;
        letter-spacing: 0.18em;
        margin-top: 1px;
        white-space: nowrap;
    }

    .sidebar-menu {
        flex: 1;
        padding: 0 1rem;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .menu-section {
        margin-bottom: 2rem;
    }

    .section-title {
        display: block;
        font-size: 9.5px;
        font-weight: 700;
        color: var(--text-dim);
        letter-spacing: 0.14em;
        margin-bottom: 0.625rem;
        padding-left: 0.625rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .menu-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 0.875rem;
        border-radius: 12px;
        color: var(--text-muted);
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.25s ease;
        margin-bottom: 0.2rem;
        background: transparent;
        border: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
        text-decoration: none;
        white-space: nowrap;
        overflow: hidden;
    }

    .menu-item span {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .item-icon {
        flex-shrink: 0;
    }

    .menu-item:hover {
        background-color: var(--bg-card);
        color: var(--text-main);
    }

    .menu-item.active {
        background-color: var(--accent-primary);
        color: white;
        box-shadow: 0 8px 16px -8px var(--accent-primary);
    }

    .menu-item.logout {
        color: var(--accent-danger);
    }

    .menu-item.logout:hover {
        background-color: rgba(239, 68, 68, 0.08);
        color: var(--accent-danger);
    }

    .logout-icon {
        color: inherit;
    }

    .sidebar-footer {
        padding: 1.25rem 1rem;
        margin-top: auto;
        flex-shrink: 0;
    }

    .theme-switch {
        width: 100%;
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 0.625rem 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--text-muted);
        font-size: 0.825rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.25s ease;
        white-space: nowrap;
        overflow: hidden;
    }

    .theme-switch:hover {
        background: var(--bg-glass);
        color: var(--text-main);
    }

    .switch-icons {
        width: 28px;
        height: 28px;
        min-width: 28px;
        background: var(--bg-sidebar);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .switch-text {
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .sun-icon { display: none; }
    .moon-icon { display: block; }

    :root[data-theme="light"] .sun-icon { display: block; }
    :root[data-theme="light"] .moon-icon { display: none; }

    .footer-divider {
        height: 1px;
        background: var(--border-subtle);
        margin: 1rem 0.25rem;
    }

    /* ============================================================
       MAIN AREA
       ============================================================ */
    .dashboard-main {
        flex: 1;
        min-width: 0; /* Critical: prevents flex child from overflowing */
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .main-header {
        height: var(--header-height, 72px);
        min-height: var(--header-height, 72px);
        padding: 0 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-main);
        border-bottom: 1px solid var(--border-subtle);
        flex-shrink: 0;
        gap: 1rem;
    }

    .greeting-box {
        min-width: 0;
        overflow: hidden;
    }

    .welcome-text {
        font-size: 1.5rem;
        font-weight: 300;
        letter-spacing: -0.01em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .user-id {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 1px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .header-actions {
        display: flex;
        align-items: center;
        flex-shrink: 0;
    }

    .profile-summary {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .profile-text {
        text-align: right;
        min-width: 0;
    }

    .email-label {
        display: block;
        font-size: 0.72rem;
        font-weight: 400;
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 160px;
    }

    .badge-elite {
        display: inline-block;
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        color: white;
        font-size: 8.5px;
        font-weight: 800;
        padding: 0.18rem 0.55rem;
        border-radius: 99px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-top: 3px;
        white-space: nowrap;
    }

    .profile-orb {
        width: 42px;
        height: 42px;
        min-width: 42px;
        border-radius: 14px;
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        border: 2px solid var(--border-medium);
        box-shadow: 0 6px 14px -4px rgba(59, 130, 246, 0.3);
    }

    .main-scroll {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        min-height: 0;
    }

    /* Updated Wrapper to match PropertyForm max width */
    .content-wrapper {
        padding: 2rem;
        max-width: 100%;
        display: flex;
        justify-content: center;
    }

    /* ============================================================
       RESPONSIVE
       ============================================================ */
    @media (max-width: 1200px) {
        :root {
            --sidebar-width: 220px;
        }
    }

    @media (max-width: 1024px) {
        .dashboard-sidebar {
            width: 64px;
            min-width: 64px;
        }
        .brand-info,
        .section-title,
        .menu-item span,
        .switch-text,
        .badge-elite,
        .email-label { display: none; }
        .menu-item { justify-content: center; padding: 0.875rem; }
        .theme-switch { justify-content: center; padding: 0.625rem; }
        .sidebar-header { padding: 1.5rem 0.75rem; }
        .brand-box { justify-content: center; }
        .sidebar-menu { padding: 0 0.5rem; }
        .sidebar-footer { padding: 1rem 0.5rem; }
    }

    @media (max-width: 768px) {
        .dashboard-root { flex-direction: column; }
        .dashboard-sidebar {
            width: 100%;
            min-width: 100%;
            height: auto;
            border-right: none;
            border-bottom: 1px solid var(--border-subtle);
        }
        .sidebar-menu { display: none; }
        .main-header { height: auto; padding: 1.25rem 1.5rem; }
        .content-wrapper { padding: 1.25rem; }
    }
</style>
